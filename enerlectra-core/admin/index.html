<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Enerlectra — Community-Owned Energy Infrastructure</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; }
    h1, h2 { margin-bottom: 0.4rem; }
    table { border-collapse: collapse; margin-top: 0.5rem; width: 100%; max-width: 900px; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; font-size: 14px; }
    th { background: #f4f4f4; text-align: left; }
    button { padding: 4px 8px; font-size: 13px; cursor: pointer; }
    .row-actions { white-space: nowrap; }
    .status-healthy { color: #0a0; font-weight: 600; }
    .status-stressed { color: #c60; font-weight: 600; }
    .status-offline { color: #c00; font-weight: 600; }
    .panel { margin-top: 1.5rem; }
    input { padding: 3px 4px; font-size: 13px; width: 70px; }
    label { font-size: 13px; margin-right: 8px; }
    #log { font-size: 12px; white-space: pre-wrap; background: #fafafa; border: 1px solid #eee; padding: 8px; margin-top: 1rem; max-width: 900px; }

    /* Status legend badges */
    #status-legend {
      margin-top: 0.5rem;
      font-size: 12px;
    }
    #status-legend span {
      display: inline-flex;
      align-items: center;
      margin-right: 8px;
    }
    #status-legend span::before {
      content: '';
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 4px;
      background: currentColor;
    }
  </style>
</head>
<body>
  <h1>Enerlectra — Community-Owned Energy Infrastructure</h1>
  <h2>Admin – Ownership, Contribution, Outcome</h2>

  <div class="panel">
    <h2>1. Clusters</h2>
    <p>Select a cluster to inspect ownership and simulate outcomes.</p>
    <table id="clusters-table">
      <thead>
        <tr>
          <th>Cluster ID</th>
          <th>Name</th>
          <th>Target kW</th>
          <th>Status</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="clusters-body">
        <tr><td colspan="6">Loading clusters…</td></tr>
      </tbody>
    </table>
  </div>

  <div class="panel">
    <h2>2. Ownership (Derived from Contributions)</h2>
    <p id="ownership-cluster-label">No cluster selected.</p>
    <table id="ownership-table">
      <thead>
        <tr>
          <th>User ID</th>
          <th>Amount (ZMW)</th>
          <th>Ownership %</th>
        </tr>
      </thead>
      <tbody id="ownership-body">
        <tr><td colspan="3">Select a cluster above.</td></tr>
      </tbody>
    </table>
  </div>

  <div class="panel">
    <h2>3. 30-Day Simulation (Outcome)</h2>
    <p id="simulation-cluster-label">No cluster selected.</p>
    <div>
      <label>Days: <input id="sim-days" type="number" value="30" /></label>
      <label>Peak kWh/kW: <input id="sim-peak" type="number" step="0.1" value="4.5" /></label>
      <label>Avg kWh/house: <input id="sim-avg" type="number" step="0.1" value="8" /></label>
      <label>Households: <input id="sim-households" type="number" value="120" /></label>
      <button id="run-sim-btn" disabled>Run Simulation</button>
    </div>
    <table id="simulation-table">
      <thead>
        <tr>
          <th>Total Generation (kWh)</th>
          <th>Total Consumption (kWh)</th>
          <th>Surplus (kWh)</th>
          <th>Deficit (kWh)</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="simulation-body">
        <tr><td colspan="5">Select a cluster and run simulation.</td></tr>
      </tbody>
    </table>

    <div id="status-legend">
      <strong>Status legend:</strong>
      <span class="status-healthy">healthy</span>
      <span class="status-stressed">stressed</span>
      <span class="status-offline">offline</span>
    </div>
  </div>

  <div class="panel">
    <h2>4. Distribution (Outcome → Owners)</h2>
    <p id="distribution-cluster-label">No cluster selected.</p>
    <div>
      <button id="run-distribute-btn" disabled>Run Distribution</button>
    </div>
    <table id="distribution-table">
      <thead>
        <tr>
          <th>User ID</th>
          <th>Ownership %</th>
          <th>Distribution (kWh)</th>
        </tr>
      </thead>
      <tbody id="distribution-body">
        <tr><td colspan="3">Select a cluster and run distribution.</td></tr>
      </tbody>
    </table>
  </div>

  <div id="log"></div>

  <footer style="margin-top: 1.5rem; font-size: 12px; color: #555;">
    All ownership and outcomes are derived from recorded contributions.
  </footer>

  <script>
    const API_BASE = 'http://localhost:3000';
    let selectedClusterId = null;

    function log(msg) {
      const el = document.getElementById('log');
      const ts = new Date().toISOString();
      el.textContent = '[' + ts + '] ' + msg + '\n' + el.textContent;
    }

    async function fetchJson(url, options) {
      const res = await fetch(url, options);
      if (!res.ok) {
        const text = await res.text();
        throw new Error('HTTP ' + res.status + ': ' + text);
      }
      return res.json();
    }

    async function loadClusters() {
      try {
        const clusters = await fetchJson(API_BASE + '/clusters');

        // Only expose the Kabwe demo cluster in the admin UI
        const demoClusters = clusters.filter(c => c.clusterId === 'clu_kabwe_demo');

        const tbody = document.getElementById('clusters-body');
        tbody.innerHTML = '';
        if (!demoClusters.length) {
          tbody.innerHTML =
            '<tr><td colspan="6">Demo cluster not found. Check seed for clu_kabwe_demo.</td></tr>';
          return;
        }

        demoClusters.forEach(function (c) {
          const tr = document.createElement('tr');
          tr.innerHTML =
            '<td>' + c.clusterId + '</td>' +
            '<td>' + c.name + '</td>' +
            '<td>' + c.target_kW + '</td>' +
            '<td>' + c.status + '</td>' +
            '<td>' + (c.createdAt ? new Date(c.createdAt).toLocaleString() : '') + '</td>' +
            '<td class="row-actions">' +
              '<button data-id="' + c.clusterId + '" class="btn-ownership">Ownership</button> ' +
              '<button data-id="' + c.clusterId + '" class="btn-simulate">Simulate</button>' +
            '</td>';
          tbody.appendChild(tr);
        });

        // Event delegation for both buttons
        tbody.addEventListener('click', function (e) {
          const btn = e.target;
          if (!(btn instanceof HTMLButtonElement)) return;
          const id = btn.getAttribute('data-id');
          if (!id) return;

          if (btn.classList.contains('btn-ownership')) {
            loadOwnership(id);
            selectClusterForActions(id);
          } else if (btn.classList.contains('btn-simulate')) {
            selectClusterForActions(id);
          }
        });
      } catch (err) {
        log('Error loading clusters: ' + err.message);
      }
    }

    async function loadOwnership(clusterId) {
      try {
        selectedClusterId = clusterId;
        document.getElementById('ownership-cluster-label').textContent =
          'Cluster: ' + clusterId;
        document.getElementById('distribution-cluster-label').textContent =
          'Cluster: ' + clusterId;

        const ownershipView = await fetchJson(API_BASE + '/clusters/' + clusterId + '/ownership');
        const tbody = document.getElementById('ownership-body');
        tbody.innerHTML = '';
        if (!ownershipView.ownership || !ownershipView.ownership.length) {
          tbody.innerHTML = '<tr><td colspan="3">No ownership data.</td></tr>';
          return;
        }
        ownershipView.ownership.forEach(function (o) {
          const tr = document.createElement('tr');
          tr.innerHTML =
            '<td>' + o.userId + '</td>' +
            '<td>' + o.amountZMW + '</td>' +
            '<td>' + o.pct.toFixed(2) + '%</td>';
          tbody.appendChild(tr);
        });
        log('Loaded ownership for ' + clusterId);
      } catch (err) {
        log('Error loading ownership: ' + err.message);
      }
    }

    function selectClusterForActions(clusterId) {
      selectedClusterId = clusterId;
      document.getElementById('simulation-cluster-label').textContent =
        'Cluster: ' + clusterId;
      document.getElementById('distribution-cluster-label').textContent =
        'Cluster: ' + clusterId;

      document.getElementById('run-sim-btn').disabled = false;
      document.getElementById('run-distribute-btn').disabled = false;

      document.getElementById('simulation-body').innerHTML =
        '<tr><td colspan="5">Ready to run simulation for ' + clusterId + '.</td></tr>';
      document.getElementById('distribution-body').innerHTML =
        '<tr><td colspan="3">Ready to run distribution for ' + clusterId + '.</td></tr>';

      log('Cluster ' + clusterId + ' selected for simulation and distribution');
    }

    async function runSimulation() {
      if (!selectedClusterId) return;

      const days = Number(document.getElementById('sim-days').value);
      const peakKwhPerKW = Number(document.getElementById('sim-peak').value);
      const avgConsumptionPerHouse = Number(document.getElementById('sim-avg').value);
      const households = Number(document.getElementById('sim-households').value);

      log(
        'Running simulation for ' + selectedClusterId +
        ' with days=' + days +
        ', peakKwhPerKW=' + peakKwhPerKW +
        ', avgConsumptionPerHouse=' + avgConsumptionPerHouse +
        ', households=' + households
      );

      const body = {
        days: days,
        peakKwhPerKW: peakKwhPerKW,
        avgConsumptionPerHouse: avgConsumptionPerHouse,
        households: households
      };

      try {
        const result = await fetchJson(
          API_BASE + '/clusters/' + selectedClusterId + '/simulate',
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          }
        );
        const tbody = document.getElementById('simulation-body');
        let statusClass = 'status-offline';
        if (result.status === 'healthy') statusClass = 'status-healthy';
        else if (result.status === 'stressed') statusClass = 'status-stressed';

        tbody.innerHTML =
          '<tr>' +
            '<td>' + result.totalGenerationKwh + '</td>' +
            '<td>' + result.totalConsumptionKwh + '</td>' +
            '<td>' + result.surplusKwh + '</td>' +
            '<td>' + result.deficitKwh + '</td>' +
            '<td class="' + statusClass + '">' + result.status + '</td>' +
          '</tr>';
        log('Simulation complete for ' + selectedClusterId);
      } catch (err) {
        log('Error running simulation: ' + err.message);
      }
    }

    async function runDistribution() {
      if (!selectedClusterId) return;

      // For demo: distribute a fixed surplus pool of 10,000 kWh
      const body = { totalSurplusKwh: 10000 };

      log(
        'Running distribution for ' + selectedClusterId +
        ' with totalSurplusKwh=' + body.totalSurplusKwh
      );

      try {
        const result = await fetchJson(
          API_BASE + '/clusters/' + selectedClusterId + '/distribute',
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          }
        );

        const tbody = document.getElementById('distribution-body');
        tbody.innerHTML = '';

        if (!result.distribution || !result.distribution.length) {
          tbody.innerHTML =
            '<tr><td colspan="3">No distribution data returned.</td></tr>';
          return;
        }

        result.distribution.forEach(function (row) {
  const tr = document.createElement('tr');
  tr.innerHTML =
    '<td>' + row.userId + '</td>' +
    '<td>' + row.ownershipPct.toFixed(2) + '%</td>' +
    '<td>' + row.allocatedKwh + '</td>';
  tbody.appendChild(tr);
});


        log('Distribution complete for ' + selectedClusterId);
      } catch (err) {
        log('Error running distribution: ' + err.message);
      }
    }

    document.getElementById('run-sim-btn').addEventListener('click', runSimulation);
    document.getElementById('run-distribute-btn').addEventListener('click', runDistribution);

    loadClusters();
  </script>
</body>
</html>
